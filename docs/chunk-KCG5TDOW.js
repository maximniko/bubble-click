import{a as F,b as X}from"./chunk-CICMDVDG.js";import"./chunk-DXDARVBW.js";import{b as G,c as V,d as L,e as R,f as W,h as b,i as $,j as q,k as z,l as H,m as D,o as g}from"./chunk-OP6W2PBE.js";import{b as K,c as Q,g as U}from"./chunk-IFSWMRX4.js";import"./chunk-JIHTAVX4.js";import{a as Y}from"./chunk-SG6BUMOX.js";import{h as j}from"./chunk-EGXIULMI.js";import{Ga as r,Ha as n,Pa as d,Ta as w,Tb as O,Ub as T,Wb as M,Xa as m,Yb as S,ab as N,bb as _,cb as c,db as s,dc as J,ea as u,eb as f,hb as x,jc as C,mb as l,nb as B,ob as v,qb as P,rb as h,tb as k,ub as A,vb as E}from"./chunk-NGIYV43Q.js";var ne=(o,a)=>a.id,se=(o,a)=>({"is-invalid":o,"is-valid":a});function ae(o,a){if(o&1&&(c(0,"option",2),l(1),s()),o&2){let e=a.$implicit,t=x();m("ngValue",e),r(),B(t.planToLabel(e))}}function pe(o,a){if(o&1&&(c(0,"div",6),l(1),s()),o&2){let e,t=x();r(),v(" ",t.validationErrors(t.planErrors,(e=t.localisation.t.Plan)!==null&&e!==void 0?e:"Plan")," ")}}var I=class o extends F{constructor(e,t){super();this.formBuilder=e;this.coinsService=t;this.maxSum=this.coinsService.balance}parentForm;maxSum;comparePlan(e,t){return e&&t?e.id==t.id:!1}ngOnInit(){this.parentForm.addControl("plan",this.formBuilder.control("",[G.required]))}get plan(){return this.parentForm.get("plan")}get planErrors(){return this.errors(this.plan)}get isInvalidPlan(){return this.isInvalid(this.plan)}planToLabel=Q;planList=K;static \u0275fac=function(t){return new(t||o)(n(D),n(C))};static \u0275cmp=u({type:o,selectors:[["deposit-inputs"]],inputs:{parentForm:"parentForm"},standalone:!0,features:[P([],[{provide:V,useExisting:b}]),d,h],decls:8,vars:9,consts:[[1,"form-floating","mb-3"],["type","text","id","form-plan","formControlName","plan",1,"form-select",3,"ngClass","compareWith"],[3,"ngValue"],["for","form-plan"],["class","invalid-feedback",4,"ngIf"],[3,"parentForm","max"],[1,"invalid-feedback"]],template:function(t,i){if(t&1&&(c(0,"div",0)(1,"select",1),N(2,ae,2,2,"option",2,ne),s(),c(4,"label",3),l(5),s(),w(6,pe,2,1,"div",4),s(),f(7,"sum-input",5)),t&2){let p;r(),m("ngClass",k(6,se,i.isInvalidPlan,i.parentForm.valid))("compareWith",i.comparePlan),r(),_(i.planList),r(3),B((p=i.localisation.t.Plan)!==null&&p!==void 0?p:"Plan"),r(),m("ngIf",i.isInvalidPlan),r(),m("parentForm",i.parentForm)("max",i.maxSum)}},dependencies:[S,O,T,g,z,H,q,L,$,X],encapsulation:2})};var Z=class o extends F{constructor(e,t,i,p,y){super();this.coinsService=e;this.depositService=t;this.twa=i;this.router=p;this.formBuilder=y;this.addDeposit=this.addDeposit.bind(this),this.goBack=this.goBack.bind(this),this.form=this.formBuilder.group({}),this.startDeposits=this.depositService.deposits}form;formSubscription;depositsSubscription;startDeposits;ngOnInit(){this.formSubscription=this.form.statusChanges.subscribe(e=>this.twa.mainButtonIsActive(e=="VALID")),this.depositsSubscription=this.depositService.depositsSubject.subscribe({next:e=>this.onNextBalance(e),error:e=>{this.twa.showAlert(e.toString())}}),this.twa.setMainButton({text:"\u0421\u043E\u0437\u0434\u0430\u0442\u044C",is_active:!0,is_visible:!0},this.addDeposit),this.twa.backButtonOnClick(this.goBack)}ngOnDestroy(){this.formSubscription?.unsubscribe(),this.depositsSubscription?.unsubscribe(),this.twa.offMainButton(this.addDeposit),this.twa.offBackButton(this.goBack)}addDeposit(){this.depositService.loadDeposits()}onNextBalance(e){if(this.startDeposits.length&&e.toString()!==this.startDeposits.toString()){this.goBack();return}if(this.form.updateValueAndValidity(),this.form.invalid)return;let t=Array.from(e),i=this.form.value,p=this.coinsService.balance;if(i.sum>p){this.twa.showAlert("\u041E\u0448\u0438\u0431\u043A\u0430 \u0431\u0430\u043B\u0430\u043D\u0441\u0430");return}if(!(!i.plan||!i.sum||isNaN(i.sum))){i.fromDate=new Date,t.push(i);try{this.coinsService.saveBalance(p-i.sum),this.depositService.saveDeposits(t),this.form.reset()}catch(y){this.twa.showAlert(y.message),this.coinsService.saveBalance(p),this.depositService.saveDeposits(e)}}}goBack(){this.router.navigate([Y.deposit()])}static \u0275fac=function(t){return new(t||o)(n(C),n(U),n(J),n(j),n(D))};static \u0275cmp=u({type:o,selectors:[["ng-component"]],hostAttrs:[1,"d-flex","flex-column","h-100"],standalone:!0,features:[d,h],decls:9,vars:5,consts:[[1,"accent-border","accent-border-top","accent-bg-shadow","rounded-5","tg-bg-secondary"],[1,"hstack","p-3","pb-0","color-accent"],[1,"m-auto","text-center","h5"],[1,"d-flex","flex-column","h-100","mb-5"],[1,"mx-2","my-4"],[3,"formGroup"],[3,"parentForm"]],template:function(t,i){t&1&&(c(0,"section",0)(1,"div",1)(2,"span",2),l(3),A(4,"async"),s()(),c(5,"div",3)(6,"div",4)(7,"form",5),f(8,"deposit-inputs",6),s()()()()),t&2&&(r(3),v("\u041D\u043E\u0432\u044B\u0439 \u0434\u0435\u043F\u043E\u0437\u0438\u0442 (\u043C\u0430\u043A\u0441. ",E(4,3,i.coinsService.balanceSubject),"):"),r(4),m("formGroup",i.form),r(),m("parentForm",i.form))},dependencies:[S,M,g,W,R,b,I],encapsulation:2})};export{Z as DepositAddComponent};
