import{a as C,b as X}from"./chunk-XXWLC2KS.js";import{b as V,c as L,d as R,e as W,f as $,h as S,i as q,j as z,k as H,l as J,m as b,o as g}from"./chunk-3M66XRBB.js";import{a as ie}from"./chunk-NKNBL4SW.js";import{b as Q,f as U}from"./chunk-Z4P65P56.js";import{a as D}from"./chunk-EQH2HHIG.js";import{a as Y}from"./chunk-JBKHYHBY.js";import{h as G}from"./chunk-GJYJS3HN.js";import"./chunk-3GRX4NBC.js";import{Ha as n,Ia as s,Qa as u,Ua as y,Xb as T,Ya as m,Yb as M,_b as j,ac as h,bb as w,cb as N,db as c,e as te,ea as d,eb as a,fb as f,ib as I,ic as K,nb as l,ob as B,pb as _,rb as P,tb as k,ub as v,wb as A,xb as E,yb as O}from"./chunk-A2ON4HJS.js";var Z=te(ie());var pe=(r,p)=>p.id,me=(r,p)=>({"is-invalid":r,"is-valid":p});function ce(r,p){if(r&1&&(c(0,"option",2),l(1),a()),r&2){let e=p.$implicit,t=I();m("ngValue",e),n(),B(t.planToLabel(e))}}function le(r,p){if(r&1&&(c(0,"div",6),l(1),a()),r&2){let e,t=I();n(),_(" ",t.validationErrors(t.planErrors,(e=t.localisation.messages.Plan)!==null&&e!==void 0?e:"Plan")," ")}}var F=class r extends C{constructor(e,t){super();this.formBuilder=e;this.coinsService=t;this.maxSum=this.coinsService.balance}parentForm;maxSum;comparePlan(e,t){return e&&t?e.id==t.id:!1}ngOnInit(){this.parentForm.addControl("plan",this.formBuilder.control("",[V.required]))}get plan(){return this.parentForm.get("plan")}get planErrors(){return this.errors(this.plan)}get isInvalidPlan(){return this.isInvalid(this.plan)}planToLabel(e){return(0,Z.sprintf)(this.localisation.messages.planToLabel??"%d% per %d days",e.percents,e.days)}planList=Q;static \u0275fac=function(t){return new(t||r)(s(b),s(D))};static \u0275cmp=d({type:r,selectors:[["deposit-inputs"]],inputs:{parentForm:"parentForm"},standalone:!0,features:[k([],[{provide:L,useExisting:S}]),u,v],decls:8,vars:9,consts:[[1,"form-floating","mb-3"],["type","text","id","form-plan","formControlName","plan",1,"form-select",3,"ngClass","compareWith"],[3,"ngValue"],["for","form-plan"],["class","invalid-feedback",4,"ngIf"],[3,"parentForm","max"],[1,"invalid-feedback"]],template:function(t,i){if(t&1&&(c(0,"div",0)(1,"select",1),w(2,ce,2,2,"option",2,pe),a(),c(4,"label",3),l(5),a(),y(6,le,2,1,"div",4),a(),f(7,"sum-input",5)),t&2){let o;n(),m("ngClass",A(6,me,i.isInvalidPlan,i.parentForm.valid))("compareWith",i.comparePlan),n(),N(i.planList),n(3),B((o=i.localisation.messages.Plan)!==null&&o!==void 0?o:"Plan"),n(),m("ngIf",i.isInvalidPlan),n(),m("parentForm",i.parentForm)("max",i.maxSum)}},dependencies:[h,T,M,g,H,J,z,R,q,X],encapsulation:2})};var ee=class r extends C{constructor(e,t,i,o,x){super();this.coinsService=e;this.depositService=t;this.twa=i;this.router=o;this.formBuilder=x;this.addDeposit=this.addDeposit.bind(this),this.goBack=this.goBack.bind(this),this.form=this.formBuilder.group({}),this.startDeposits=this.depositService.deposits}form;formSubscription;depositsSubscription;startDeposits;ngOnInit(){this.formSubscription=this.form.statusChanges.subscribe(e=>this.twa.mainButtonIsActive(e=="VALID")),this.depositsSubscription=this.depositService.depositsSubject.subscribe({next:e=>this.onNextBalance(e),error:e=>{this.twa.showAlert(e.toString())}}),this.twa.setMainButton({text:this.localisation.messages.Create??"Create",is_active:!0,is_visible:!0},this.addDeposit),this.twa.backButtonOnClick(this.goBack)}ngOnDestroy(){this.formSubscription?.unsubscribe(),this.depositsSubscription?.unsubscribe(),this.twa.offMainButton(this.addDeposit),this.twa.offBackButton(this.goBack)}addDeposit(){this.depositService.loadDeposits()}onNextBalance(e){if(this.startDeposits.length&&e.toString()!==this.startDeposits.toString()){this.goBack();return}if(this.form.updateValueAndValidity(),this.form.invalid)return;let t=Array.from(e),i=this.form.value,o=this.coinsService.balance;if(i.sum>o){this.twa.showAlert(this.localisation.messages.AlertBalanceError??"Balance error!");return}if(!(!i.plan||!i.sum||isNaN(i.sum))){i.fromDate=new Date,t.push(i);try{this.coinsService.saveBalance(o-i.sum),this.depositService.saveDeposits(t),this.form.reset()}catch(x){this.twa.showAlert(x.message),this.coinsService.saveBalance(o),this.depositService.saveDeposits(e)}}}goBack(){this.router.navigate([Y.deposit()])}static \u0275fac=function(t){return new(t||r)(s(D),s(U),s(K),s(G),s(b))};static \u0275cmp=d({type:r,selectors:[["ng-component"]],hostAttrs:[1,"d-flex","flex-column","h-100"],standalone:!0,features:[u,v],decls:9,vars:7,consts:[[1,"accent-border","accent-border-top","accent-bg-shadow","rounded-5","tg-bg-secondary"],[1,"hstack","p-3","pb-0","color-accent"],[1,"m-auto","text-center","h5"],[1,"d-flex","flex-column","h-100","mb-5"],[1,"mx-2","my-4"],[3,"formGroup"],[3,"parentForm"]],template:function(t,i){if(t&1&&(c(0,"section",0)(1,"div",1)(2,"span",2),l(3),E(4,"async"),a()(),c(5,"div",3)(6,"div",4)(7,"form",5),f(8,"deposit-inputs",6),a()()()()),t&2){let o;n(3),P("",(o=i.localisation.messages.NewDeposit)!==null&&o!==void 0?o:"New deposit"," (",(o=i.localisation.messages.max)!==null&&o!==void 0?o:"max."," ",O(4,5,i.coinsService.balanceSubject),"):"),n(4),m("formGroup",i.form),n(),m("parentForm",i.form)}},dependencies:[h,j,g,$,W,S,F],encapsulation:2})};export{ee as DepositAddComponent};
